<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>聊天室</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
</head>
<body>
    <div class="chat-container">
        <!-- 左侧边栏 -->
        <div class="sidebar">
            <div class="user-info" onclick="toggleUserMenu()">
                <img src="{{ current_user.get_avatar_url() }}" alt="头像" class="user-avatar">
                <div class="user-details">
                    <div class="user-name">{{ current_user.username }}</div>
                    <div class="user-status">在线</div>
                </div>
            </div>
            
            <!-- 用户菜单 -->
            <div class="user-menu" id="userMenu">
                <a href="{{ url_for('main.settings') }}" class="menu-item">
                    <svg viewBox="0 0 24 24">
                        <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                    </svg>
                    设置
                </a>
                <a href="{{ url_for('main.logout') }}" class="menu-item">
                    <svg viewBox="0 0 24 24">
                        <path d="M17,7l-1.41,1.41L18.17,11H8v2h10.17l-2.58,2.58L17,17l5-5L17,7z M4,5h8V3H4C2.9,3,2,3.9,2,5v14c0,1.1,0.9,2,2,2h8v-2H4V5z"/>
                    </svg>
                    退出登录
                </a>
            </div>
            
            <div class="sidebar-header">
                <h2>聊天室</h2>
            </div>
            <div class="chat-list">
                <!-- 这里可以后续添加聊天列表 -->
            </div>
            <!-- 添加底部操作栏 -->
            <div class="sidebar-footer">
                <a href="{{ url_for('main.settings') }}" class="action-btn" title="设置">
                    <svg viewBox="0 0 24 24">
                        <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                    </svg>
                </a>
                <button onclick="window.location.href='{{ url_for('main.logout') }}'" class="action-btn" title="登出">
                    <svg viewBox="0 0 24 24">
                        <path d="M17,7l-1.41,1.41L18.17,11H8v2h10.17l-2.58,2.58L17,17l5-5L17,7z M4,5h8V3H4C2.9,3,2,3.9,2,5v14c0,1.1,0.9,2,2,2h8v-2H4V5z"/>
                    </svg>
                </button>
                <!-- 开发人员列表 -->
                <div class="dev-team">
                    <h3>开发团队</h3>
                    <div class="dev-list">
                        <a href="https://github.com/ziyuan77-gev" class="dev-link" target="_blank">
                            <svg viewBox="0 0 24 24">
                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                            </svg>
                            ziyuan77
                        </a>
                        <a href="https://github.com/Seikoa" class="dev-link" target="_blank">
                            <svg viewBox="0 0 24 24">
                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                            </svg>
                            Seikoa
                        </a>
                        <a href="https://github.com/xhdndmm" class="dev-link" target="_blank">
                            <svg viewBox="0 0 24 24">
                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                            </svg>
                            xhdndmm
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧聊天区域 -->
        <div class="chat-area">
            <div class="chat-header">
                <h3>公共聊天室</h3>
            </div>
            
            <div class="messages" id="messages">
                <!-- 消息会动态插入到这里 -->
            </div>

            <div class="typing-status" id="typing-status"></div>

            <!-- 表情面板放在这里 -->
            <div class="emoji-panel" id="emoji-panel" style="display: none;">
                <div class="emoji-container">
                    <!-- 基础表情 -->
                    <div class="emoji-group">
                        <span class="emoji" data-emoji="😊">😊</span>
                        <span class="emoji" data-emoji="😂">😂</span>
                        <span class="emoji" data-emoji="🤣">🤣</span>
                        <span class="emoji" data-emoji="😅">😅</span>
                        <span class="emoji" data-emoji="😆">😆</span>
                        <span class="emoji" data-emoji="😉">😉</span>
                        <span class="emoji" data-emoji="😋">😋</span>
                        <span class="emoji" data-emoji="😎">😎</span>
                        <span class="emoji" data-emoji="😍">😍</span>
                        <span class="emoji" data-emoji="🥰">🥰</span>
                        <span class="emoji" data-emoji="😘">😘</span>
                        <span class="emoji" data-emoji="🤗">🤗</span>
                        <span class="emoji" data-emoji="🤔">🤔</span>
                        <span class="emoji" data-emoji="🤨">🤨</span>
                        <span class="emoji" data-emoji="😐">😐</span>
                        <span class="emoji" data-emoji="😑">😑</span>
                        <span class="emoji" data-emoji="😶">😶</span>
                        <span class="emoji" data-emoji="🙄">🙄</span>
                        <span class="emoji" data-emoji="😏">😏</span>
                        <span class="emoji" data-emoji="😣">😣</span>
                        <span class="emoji" data-emoji="😥">😥</span>
                        <span class="emoji" data-emoji="😮">😮</span>
                        <span class="emoji" data-emoji="😯">😯</span>
                        <span class="emoji" data-emoji="😪">😪</span>
                        <span class="emoji" data-emoji="😫">😫</span>
                        <span class="emoji" data-emoji="😴">😴</span>
                        <span class="emoji" data-emoji="😌">😌</span>
                        <span class="emoji" data-emoji="😛">😛</span>
                        <span class="emoji" data-emoji="😜">😜</span>
                        <span class="emoji" data-emoji="😝">😝</span>
                        <span class="emoji" data-emoji="🤤">🤤</span>
                        <span class="emoji" data-emoji="😒">😒</span>
                        <span class="emoji" data-emoji="😓">😓</span>
                        <span class="emoji" data-emoji="😔">😔</span>
                        <span class="emoji" data-emoji="😕">😕</span>
                        <span class="emoji" data-emoji="🙃">🙃</span>
                        <span class="emoji" data-emoji="🤑">🤑</span>
                        <span class="emoji" data-emoji="😲">😲</span>
                        <span class="emoji" data-emoji="😳">😳</span>
                        <span class="emoji" data-emoji="🥺">🥺</span>
                    </div>
                </div>
            </div>

            <form id="message-form" class="message-input">
                <div class="emoji-btn" title="表情">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-4-8c.61 0 1.1-.49 1.1-1.1 0-.61-.49-1.1-1.1-1.1-.61 0-1.1.49-1.1 1.1 0 .61.49 1.1 1.1 1.1zm8 0c.61 0 1.1-.49 1.1-1.1 0-.61-.49-1.1-1.1-1.1-.61 0-1.1.49-1.1 1.1 0 .61.49 1.1 1.1 1.1zm-4 4c2.21 0 4-1.79 4-4h-8c0 2.21 1.79 4 4 4z"/>
                    </svg>
                </div>
                <label for="file-input" class="file-upload-btn" title="添加附件">
                    <svg class="upload-icon" viewBox="0 0 24 24">
                        <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
                    </svg>
                </label>
                <input type="file" id="file-input" accept=".txt,.log,.md,.json,.xml,.yaml,.yml,.html,.htm,.css,.js,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.pdf,.zip,.rar,.7z,.tar,.gz,.jpg,.jpeg,.png,.gif,.bmp,.webp,.mp4,.webm,.avi,.mov,.wmv,.flv,.m4v,.py,.java,.cpp,.c,.h,.cs,.php,.sql" style="display: none">
                <input type="text" id="input" placeholder="输入消息..." autocomplete="off">
                <button type="submit" title="发送"></button>
            </form>
        </div>
    </div>

    <!-- 个人信息弹窗 -->
    <div id="userInfoModal" class="modal">
        <div class="modal-content user-info-modal">
            <div class="modal-header">
                <h3>用户信息</h3>
                <button class="close-btn" onclick="closeUserInfoModal()">×</button>
            </div>
            <div class="user-info-content">
                <img id="userInfoAvatar" src="" alt="用户头像" class="user-info-avatar">
                <div class="info-group">
                    <div class="info-item">
                        <span class="label">用户名</span>
                        <span id="userInfoUsername"></span>
                    </div>
                    <div class="info-item">
                        <span class="label">显示名称</span>
                        <span id="userInfoDisplayName"></span>
                    </div>
                    <div class="info-item">
                        <span class="label">个人简介</span>
                        <span id="userInfoBio"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 消息右键菜单 -->
    <div id="contextMenu" class="context-menu">
        <ul>
            <li id="editMenuItem">编辑消息</li>
            <li id="deleteMenuItem">删除消息</li>
        </ul>
    </div>

    <script>
        // 定义全局函数
        function closeUserInfoModal() {
            const modal = document.getElementById('userInfoModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const socket = io();
            const form = document.getElementById('message-form');
            const input = document.getElementById('input');
            const messages = document.getElementById('messages');
            const currentUsername = '{{ current_user.username }}';
            const fileInput = document.getElementById('file-input');

            // 添加右键菜单相关变量
            const contextMenu = document.getElementById('contextMenu');
            const editMenuItem = document.getElementById('editMenuItem');
            const deleteMenuItem = document.getElementById('deleteMenuItem');
            let currentMessageId = null;

            function appendMessage(msgData) {
                const messageDiv = document.createElement('div');
                const isOwn = msgData.username === currentUsername;
                messageDiv.className = `message ${isOwn ? 'message-own' : 'message-other'}`;
                messageDiv.setAttribute('data-message-id', msgData.id);

                // 添加头像
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'message-avatar';
                const avatarImg = document.createElement('img');
                avatarImg.src = msgData.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${msgData.username}`;
                avatarImg.alt = msgData.username;
                avatarImg.onclick = () => showUserInfo(msgData.username);
                avatarDiv.appendChild(avatarImg);
                messageDiv.appendChild(avatarDiv);

                // 消息内容容器
                const contentContainer = document.createElement('div');
                contentContainer.className = 'message-container';

                // 用户名
                const usernameDiv = document.createElement('div');
                usernameDiv.className = 'message-username';
                usernameDiv.textContent = msgData.username;
                contentContainer.appendChild(usernameDiv);

                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'message-content-wrapper';

                // 消息内容
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                
                // 根据消息类型显示不同内容
                if (msgData.type === 'file') {
                    const fileLink = document.createElement('a');
                    fileLink.href = msgData.url;
                    fileLink.target = '_blank';
                    fileLink.className = 'file-message';

                    const fileExt = msgData.filename.split('.').pop().toLowerCase();
                    
                    if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(fileExt)) {
                        // 图片文件
                        contentDiv.className = 'message-content image-message';
                        const img = document.createElement('img');
                        img.src = msgData.url;
                        img.className = 'image-preview';
                        fileLink.appendChild(img);
                    } else if (['mp4', 'webm', 'avi', 'mov', 'wmv', 'flv', 'm4v'].includes(fileExt)) {
                        // 视频文件
                        contentDiv.className = 'message-content video-message';
                        const video = document.createElement('video');
                        video.src = msgData.url;
                        video.className = 'video-preview';
                        video.controls = true;
                        video.preload = 'metadata';
                        video.playsInline = true;
                        video.poster = '';
                        
                        video.onerror = () => {
                            video.style.display = 'none';
                            const errorDiv = document.createElement('div');
                            errorDiv.className = 'video-error';
                            errorDiv.textContent = '视频加载失败';
                            fileLink.appendChild(errorDiv);
                        };
                        
                        video.onclick = (e) => {
                            e.preventDefault();
                            if (video.requestFullscreen) {
                                video.requestFullscreen();
                            } else if (video.webkitRequestFullscreen) {
                                video.webkitRequestFullscreen();
                            }
                        };
                        
                        fileLink.appendChild(video);
                    } else {
                        // 根据文件类型设置不同的图标和样式
                        let iconPath;
                        let iconClass;
                        
                        if (['zip', 'rar', '7z', 'tar', 'gz'].includes(fileExt)) {
                            iconPath = 'M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-2 6h-2v2h2v2h-2v2h-2v-2h2v-2h-2v-2h2v-2h-2V8h2v2h2v2z';
                            iconClass = 'archive';
                        } else if (['pdf'].includes(fileExt)) {
                            iconPath = 'M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm4-3H19v1h1.5V11H19v2h-1.5V7h3v1.5zM9 9.5h1v-1H9v1zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm10 5.5h1v-3h-1v3z';
                            iconClass = 'pdf';
                        } else if (['doc', 'docx'].includes(fileExt)) {
                            iconPath = 'M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-3 14H8c-.55 0-1-.45-1-1s.45-1 1-1h8c.55 0 1 .45 1 1s-.45 1-1 1zm0-4H8c-.55 0-1-.45-1-1s.45-1 1-1h8c.55 0 1 .45 1 1s-.45 1-1 1zm0-4H8c-.55 0-1-.45-1-1s.45-1 1-1h8c.55 0 1 .45 1 1s-.45 1-1 1z';
                            iconClass = 'doc';
                        } else if (['txt', 'json', 'log', 'md', 'xml', 'csv'].includes(fileExt)) {
                            iconPath = 'M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z';
                            iconClass = 'doc';
                        } else if (['html', 'htm', 'css', 'js'].includes(fileExt)) {
                            // 网页文件
                            iconPath = 'M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm-1 9H7v-2h6v2zm4 4H7v-2h10v2zm0 4H7v-2h10v2z';
                            iconClass = 'code';
                        } else if (['json', 'xml', 'yaml', 'yml'].includes(fileExt)) {
                            // 数据文件
                            iconPath = 'M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm-1 9H7v-2h6v2zm4 4H7v-2h10v2zm0 4H7v-2h10v2z';
                            iconClass = 'code';
                        } else if (['py', 'java', 'cpp', 'c', 'h', 'cs', 'php', 'sql'].includes(fileExt)) {
                            // 代码文件
                            iconPath = 'M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z';
                            iconClass = 'code';
                        } else {
                            // 未知文件类型
                            iconPath = 'M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z';
                            iconClass = 'doc';
                        }

                        fileLink.innerHTML = `
                            <svg class="file-icon ${iconClass}" viewBox="0 0 24 24">
                                <path d="${iconPath}"/>
                            </svg>
                            <div class="file-info">
                                <span class="file-name">${msgData.filename}</span>
                                <span class="file-size">${formatFileSize(msgData.size)}</span>
                            </div>
                        `;
                    }
                    contentDiv.appendChild(fileLink);
                } else {
                    contentDiv.textContent = msgData.text;
                }
                
                contentWrapper.appendChild(contentDiv);

                // 添加消息信息（时间等）
                const infoDiv = document.createElement('div');
                infoDiv.className = 'message-info';
                
                // 添加时间
                const timeSpan = document.createElement('span');
                timeSpan.className = 'message-time';
                timeSpan.textContent = msgData.timestamp || new Date().toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                infoDiv.appendChild(timeSpan);

                // 如果消息被编辑过，添加编辑标记
                if (msgData.edited) {
                    const editedSpan = document.createElement('span');
                    editedSpan.className = 'message-edited';
                    editedSpan.textContent = '(已编辑)';
                    infoDiv.appendChild(editedSpan);
                }

                contentWrapper.appendChild(infoDiv);
                contentContainer.appendChild(contentWrapper);
                messageDiv.appendChild(contentContainer);

                // 为消息添加右键菜单事件（仅限自己的消息）
                if (isOwn) {
                    messageDiv.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        currentMessageId = msgData.id;
                        showContextMenu(e.pageX, e.pageY);
                    });
                }

                messages.appendChild(messageDiv);
                messages.scrollTop = messages.scrollHeight;
            }

            function editMessage(messageId) {
                const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
                const contentDiv = messageDiv.querySelector('.message-content');
                const originalText = contentDiv.textContent;
                
                contentDiv.innerHTML = `
                    <input type="text" class="edit-input" value="${originalText}">
                    <button class="save-edit">保存</button>
                    <button class="cancel-edit">取消</button>
                `;
                
                const editInput = contentDiv.querySelector('.edit-input');
                editInput.focus();
                
                contentDiv.querySelector('.save-edit').onclick = () => {
                    const newText = editInput.value.trim();
                    if (newText && newText !== originalText) {
                        socket.emit('edit_message', {
                            id: messageId,
                            text: newText
                        });
                    }
                    contentDiv.textContent = originalText;
                };
                
                contentDiv.querySelector('.cancel-edit').onclick = () => {
                    contentDiv.textContent = originalText;
                };
            }

            function deleteMessage(messageId) {
                if (confirm('确定要删除这条消息吗？')) {
                    socket.emit('delete_message', { id: messageId });
                }
            }

            // Socket.io 事件监听
            socket.on('message', appendMessage);

            socket.on('message_status', (data) => {
                const messageDiv = document.querySelector(`[data-message-id="${data.id}"]`);
                if (messageDiv) {
                    const statusSpan = messageDiv.querySelector('.message-status');
                    if (statusSpan) statusSpan.textContent = data.status;
                }
            });

            socket.on('message_edited', (data) => {
                const messageDiv = document.querySelector(`[data-message-id="${data.id}"]`);
                if (messageDiv) {
                    const contentDiv = messageDiv.querySelector('.message-content');
                    contentDiv.textContent = data.text;
                    
                    const infoDiv = messageDiv.querySelector('.message-info');
                    if (!infoDiv.querySelector('.message-edited')) {
                        const editedSpan = document.createElement('span');
                        editedSpan.className = 'message-edited';
                        editedSpan.textContent = '(已编辑)';
                        infoDiv.insertBefore(editedSpan, infoDiv.firstChild);
                    }
                }
            });

            socket.on('message_deleted', (data) => {
                const messageDiv = document.querySelector(`[data-message-id="${data.id}"]`);
                if (messageDiv) {
                    messageDiv.remove();
                }
            });

            // 表单提交
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                clearTimeout(typingTimer);
                socket.emit('typing', { status: 'stopped' });
                
                if (input.value.trim()) {
                    socket.emit('message', input.value);
                    input.value = '';
                }
            });

            const typingStatus = document.getElementById('typing-status');
            let typingTimer;
            let typingUsers = new Set();

            // 修改输入监听部分
            input.addEventListener('input', () => {
                if (input.value.trim()) {  // 只有当输入框有内容时才发送状态
                    clearTimeout(typingTimer);
                    socket.emit('typing', { status: 'typing' });
                    
                    typingTimer = setTimeout(() => {
                        socket.emit('typing', { status: 'stopped' });
                    }, 2000);
                } else {
                    clearTimeout(typingTimer);
                    socket.emit('typing', { status: 'stopped' });
                }
            });

            // 修改输入状态更新函数
            function updateTypingStatus() {
                if (typingUsers.size === 0) {
                    typingStatus.textContent = '';
                    typingStatus.style.display = 'none';
                    return;
                }

                const users = Array.from(typingUsers);
                let text = '';
                
                if (users.length === 1) {
                    text = `${users[0]} 正在输入...`;
                } else if (users.length === 2) {
                    text = `${users[0]} 和 ${users[1]} 正在输入...`;
                } else {
                    text = `${users[0]} 和其他 ${users.length - 1} 人正在输入...`;
                }

                typingStatus.textContent = text;
                typingStatus.style.display = 'block';
                console.log('Typing status updated:', text); // 添加调试日志
            }

            // 修改输入状态监听
            socket.on('typing_status', (data) => {
                console.log('Received typing status:', data); // 添加调试日志
                if (data.status === 'typing') {
                    typingUsers.add(data.username);
                } else {
                    typingUsers.delete(data.username);
                }
                updateTypingStatus();
            });

            // 处理文件选择
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    if (result.error) {
                        alert(result.error);
                    }
                    
                    // 清除文件输入
                    fileInput.value = '';
                } catch (error) {
                    console.error('Upload failed:', error);
                    alert('文件上传失败');
                }
            });

            const emojiBtn = document.querySelector('.emoji-btn');
            const emojiPanel = document.getElementById('emoji-panel');
            const emojis = document.querySelectorAll('.emoji');
            
            // 点击表情按钮显示/隐藏表情面板
            emojiBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const isVisible = emojiPanel.style.display !== 'none';
                emojiPanel.style.display = isVisible ? 'none' : 'block';
                
                if (!isVisible) {
                    // 计算表情面板的位置
                    const btnRect = emojiBtn.getBoundingClientRect();
                    emojiPanel.style.left = `${btnRect.left}px`;
                    emojiPanel.style.bottom = `${window.innerHeight - btnRect.top + 10}px`;
                }
            });
            
            // 点击其他地方关闭表情面板
            document.addEventListener('click', (e) => {
                if (!emojiPanel.contains(e.target) && !emojiBtn.contains(e.target)) {
                    emojiPanel.style.display = 'none';
                }
            });
            
            // 点击表情插入到输入框
            emojis.forEach(emoji => {
                emoji.addEventListener('click', function() {
                    const input = document.getElementById('input');
                    const emojiText = this.getAttribute('data-emoji');
                    
                    // 在��标位置插入表情
                    const start = input.selectionStart;
                    const end = input.selectionEnd;
                    input.value = input.value.slice(0, start) + emojiText + input.value.slice(end);
                    
                    // 更新光标位置
                    input.focus();
                    const newCursorPos = start + emojiText.length;
                    input.setSelectionRange(newCursorPos, newCursorPos);
                    
                    // 触发输入事件
                    input.dispatchEvent(new Event('input'));
                    
                    // 关闭表情面板
                    emojiPanel.style.display = 'none';
                });
            });

            // 显示用户信息弹窗
            async function showUserInfo(username) {
                const userInfoModal = document.getElementById('userInfoModal');
                try {
                    const response = await fetch(`/user_info/${username}`);
                    const userData = await response.json();
                    
                    document.getElementById('userInfoAvatar').src = userData.avatar_url;
                    document.getElementById('userInfoUsername').textContent = userData.username;
                    document.getElementById('userInfoDisplayName').textContent = userData.display_name || userData.username;
                    document.getElementById('userInfoBio').textContent = userData.bio || '这个用户很懒，还没有填写简介';
                    
                    userInfoModal.style.display = 'flex';
                } catch (error) {
                    console.error('获取用户信息失败:', error);
                }
            }

            // 显示右键菜单
            function showContextMenu(x, y) {
                contextMenu.style.display = 'block';
                contextMenu.style.left = `${x}px`;
                contextMenu.style.top = `${y}px`;
            }

            // 隐藏右键菜单
            function hideContextMenu() {
                contextMenu.style.display = 'none';
            }

            // 右键菜单点击事件
            editMenuItem.addEventListener('click', () => {
                if (currentMessageId) {
                    editMessage(currentMessageId);
                    hideContextMenu();
                }
            });

            deleteMenuItem.addEventListener('click', () => {
                if (currentMessageId) {
                    deleteMessage(currentMessageId);
                    hideContextMenu();
                }
            });

            // 点击其他地方关闭右键菜单
            document.addEventListener('click', hideContextMenu);

            // 阻止右键菜单冒泡
            contextMenu.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            // 添加文件大小格式化函数
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        });
    </script>
</body>
</html>