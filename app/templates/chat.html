<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ËÅäÂ§©ÂÆ§</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
</head>
<body>
    <div class="chat-container">
        <!-- Â∑¶‰æßËæπÊ†è -->
        <div class="sidebar">
            <div class="user-info" onclick="toggleUserMenu()">
                <img src="{{ current_user.get_avatar_url() }}" alt="Â§¥ÂÉè" class="user-avatar">
                <div class="user-details">
                    <div class="user-name">{{ current_user.username }}</div>
                    <div class="user-status">Âú®Á∫ø</div>
                </div>
            </div>
            
            <!-- Áî®Êà∑ËèúÂçï -->
            <div class="user-menu" id="userMenu">
                <a href="{{ url_for('main.settings') }}" class="menu-item">
                    <svg viewBox="0 0 24 24">
                        <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                    </svg>
                    ËÆæÁΩÆ
                </a>
                <a href="{{ url_for('main.logout') }}" class="menu-item">
                    <svg viewBox="0 0 24 24">
                        <path d="M17,7l-1.41,1.41L18.17,11H8v2h10.17l-2.58,2.58L17,17l5-5L17,7z M4,5h8V3H4C2.9,3,2,3.9,2,5v14c0,1.1,0.9,2,2,2h8v-2H4V5z"/>
                    </svg>
                    ÈÄÄÂá∫ÁôªÂΩï
                </a>
            </div>
            
            <div class="sidebar-header">
                <h2>ËÅäÂ§©ÂÆ§</h2>
            </div>
            <div class="chat-list">
                <!-- ËøôÈáåÂèØ‰ª•ÂêéÁª≠Ê∑ªÂä†ËÅäÂ§©ÂàóË°® -->
            </div>
            <!-- Ê∑ªÂä†Â∫ïÈÉ®Êìç‰ΩúÊ†è -->
            <div class="sidebar-footer">
                <a href="{{ url_for('main.settings') }}" class="action-btn" title="ËÆæÁΩÆ">
                    <svg viewBox="0 0 24 24">
                        <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                    </svg>
                </a>
                <button onclick="window.location.href='{{ url_for('main.logout') }}'" class="action-btn" title="ÁôªÂá∫">
                    <svg viewBox="0 0 24 24">
                        <path d="M17,7l-1.41,1.41L18.17,11H8v2h10.17l-2.58,2.58L17,17l5-5L17,7z M4,5h8V3H4C2.9,3,2,3.9,2,5v14c0,1.1,0.9,2,2,2h8v-2H4V5z"/>
                    </svg>
                </button>
                <!-- ÂºÄÂèë‰∫∫ÂëòÂàóË°® -->
                <div class="dev-team">
                    <h3>ÂºÄÂèëÂõ¢Èòü</h3>
                    <div class="dev-list">
                        <a href="https://github.com/ziyuan77-gev" class="dev-link" target="_blank">
                            <svg viewBox="0 0 24 24">
                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                            </svg>
                            ziyuan77
                        </a>
                        <a href="https://github.com/Seikoa" class="dev-link" target="_blank">
                            <svg viewBox="0 0 24 24">
                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                            </svg>
                            Seikoa
                        </a>
                        <a href="https://github.com/xhdndmm" class="dev-link" target="_blank">
                            <svg viewBox="0 0 24 24">
                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                            </svg>
                            xhdndmm
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Âè≥‰æßËÅäÂ§©Âå∫Âüü -->
        <div class="chat-area">
            <div class="chat-header">
                <h3>ÂÖ¨ÂÖ±ËÅäÂ§©ÂÆ§</h3>
            </div>
            
            <div class="messages" id="messages">
                <!-- Ê∂àÊÅØ‰ºöÂä®ÊÄÅÊèíÂÖ•Âà∞ËøôÈáå -->
            </div>

            <div class="typing-status" id="typing-status"></div>

            <!-- Ë°®ÊÉÖÈù¢ÊùøÊîæÂú®ËøôÈáå -->
            <div class="emoji-panel" id="emoji-panel" style="display: none;">
                <div class="emoji-tabs">
                    <button class="tab-button active" onclick="showTab('emoji-tab')">Ë°®ÊÉÖ</button>
                    <button class="tab-button" onclick="showTab('stickers-tab')">Ë¥¥Á∫∏</button>
                    <button class="tab-button" onclick="showTab('gifs-tab')">GIF</button>
                </div>

                <div class="tab-contents">
                    <!-- Emoji ÈÄâÈ°πÂç° -->
                    <div id="emoji-tab" class="tab-content active">
                        <div class="emoji-container">
                            <div class="emoji-group">
                                <span class="emoji" data-emoji="üòä">üòä</span>
                                <span class="emoji" data-emoji="üòÇ">üòÇ</span>
                                <span class="emoji" data-emoji="ü§£">ü§£</span>
                                <span class="emoji" data-emoji="üòÖ">üòÖ</span>
                                <!-- ‰øùÁïôÂéüÊúâÁöÑÊâÄÊúâË°®ÊÉÖ -->
                            </div>
                        </div>
                    </div>

                    <!-- Ë¥¥Á∫∏ÈÄâÈ°πÂç° -->
                    <div id="stickers-tab" class="tab-content">
                        <div class="sticker-container">
                            <!-- Ê∑ªÂä†‰∏ä‰º†ÊåâÈíÆÂà∞Ë¥¥Á∫∏ÁΩëÊ†º‰∏≠ -->
                            <div class="sticker-upload-box" onclick="document.getElementById('sticker-upload-input').click()">
                                <div class="upload-icon-large">
                                    <svg viewBox="0 0 24 24">
                                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                                    </svg>
                                </div>
                                <span>Ê∑ªÂä†Ë¥¥Á∫∏</span>
                            </div>
                        </div>
                        <input type="file" id="sticker-upload-input" style="display: none" 
                               accept="image/*" onchange="uploadSticker(this)">
                    </div>

                    <!-- GIF ÈÄâÈ°πÂç° -->
                    <div id="gifs-tab" class="tab-content">
                        <div class="gif-container">
                            <div class="gif-search">
                                <input type="text" placeholder="ÊêúÁ¥¢ GIF" id="gif-search">
                            </div>
                            <div class="gif-results">
                                <!-- GIF ÊêúÁ¥¢ÁªìÊûúÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <form id="message-form" class="message-input">
                <div class="emoji-btn" title="Ë°®ÊÉÖ">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-4-8c.61 0 1.1-.49 1.1-1.1 0-.61-.49-1.1-1.1-1.1-.61 0-1.1.49-1.1 1.1 0 .61.49 1.1 1.1 1.1zm8 0c.61 0 1.1-.49 1.1-1.1 0-.61-.49-1.1-1.1-1.1-.61 0-1.1.49-1.1 1.1 0 .61.49 1.1 1.1 1.1zm-4 4c2.21 0 4-1.79 4-4h-8c0 2.21 1.79 4 4 4z"/>
                    </svg>
                </div>
                <label for="file-input" class="file-upload-btn" title="Ê∑ªÂä†ÈôÑ‰ª∂">
                    <svg class="upload-icon" viewBox="0 0 24 24">
                        <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
                    </svg>
                </label>
                <input type="file" id="file-input" accept=".txt,.log,.md,.json,.xml,.yaml,.yml,.html,.htm,.css,.js,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.pdf,.zip,.rar,.7z,.tar,.gz,.jpg,.jpeg,.png,.gif,.bmp,.webp,.mp4,.webm,.avi,.mov,.wmv,.flv,.m4v,.py,.java,.cpp,.c,.h,.cs,.php,.sql" style="display: none">
                <input type="text" id="input" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." autocomplete="off">
                <button type="submit" title="ÂèëÈÄÅ"></button>
            </form>
        </div>
    </div>

    <!-- ‰∏™‰∫∫‰ø°ÊÅØÂºπÁ™ó -->
    <div id="userInfoModal" class="modal">
        <div class="modal-content user-info-modal">
            <div class="modal-header">
                <h3>Áî®Êà∑‰ø°ÊÅØ</h3>
                <button class="close-btn" onclick="closeUserInfoModal()">√ó</button>
            </div>
            <div class="user-info-content">
                <img id="userInfoAvatar" src="" alt="Áî®Êà∑Â§¥ÂÉè" class="user-info-avatar">
                <div class="info-group">
                    <div class="info-item">
                        <span class="label">Áî®Êà∑Âêç</span>
                        <span id="userInfoUsername"></span>
                    </div>
                    <div class="info-item">
                        <span class="label">ÊòæÁ§∫ÂêçÁß∞</span>
                        <span id="userInfoDisplayName"></span>
                    </div>
                    <div class="info-item">
                        <span class="label">‰∏™‰∫∫ÁÆÄ‰ªã</span>
                        <span id="userInfoBio"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ê∂àÊÅØÂè≥ÈîÆËèúÂçï -->
    <div id="contextMenu" class="context-menu">
        <ul>
            <li id="editMenuItem">ÁºñËæëÊ∂àÊÅØ</li>
            <li id="deleteMenuItem">Âà†Èô§Ê∂àÊÅØ</li>
        </ul>
    </div>

    <script>
        // ÂÆö‰πâÂÖ®Â±ÄÂáΩÊï∞
        function closeUserInfoModal() {
            const modal = document.getElementById('userInfoModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Â∞Ü showTab ÂáΩÊï∞ÁßªÂà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
        function showTab(tabId) {
            console.log('Switching to tab:', tabId);
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => {
                if (tab.id === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                if (button.getAttribute('onclick').includes(tabId)) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });

            if (tabId === 'stickers-tab') {
                loadStickers();
            }
        }

        // Â∞ÜÂÖ∂‰ªñË¥¥Á∫∏Áõ∏ÂÖ≥ÂáΩÊï∞‰πüÁßªÂà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
        function uploadSticker(input) {
            if (input.files && input.files[0]) {
                const formData = new FormData();
                formData.append('sticker', input.files[0]);
                
                fetch('/upload_sticker', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        loadStickers();
                        input.value = '';
                    } else {
                        alert(result.error || '‰∏ä‰º†Â§±Ë¥•');
                    }
                })
                .catch(error => {
                    console.error('‰∏ä‰º†Ë¥¥Á∫∏Â§±Ë¥•:', error);
                    alert('‰∏ä‰º†Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
                });
            }
        }

        function loadStickers() {
            fetch('/get_stickers')
                .then(response => response.json())
                .then(stickers => {
                    const container = document.querySelector('.sticker-container');
                    if (!container) return;
                    
                    container.innerHTML = '';
                    
                    // Ê∑ªÂä†‰∏ä‰º†ÊåâÈíÆ
                    const uploadBox = document.createElement('div');
                    uploadBox.className = 'sticker-upload-box';
                    uploadBox.onclick = () => document.getElementById('sticker-upload-input').click();
                    uploadBox.innerHTML = `
                        <div class="upload-icon-large">
                            <svg viewBox="0 0 24 24">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                            </svg>
                        </div>
                        <span>Ê∑ªÂä†Ë¥¥Á∫∏</span>
                    `;
                    container.appendChild(uploadBox);
                    
                    // Ê∑ªÂä†Áé∞ÊúâË¥¥Á∫∏
                    stickers.forEach(sticker => {
                        const stickerWrapper = document.createElement('div');
                        stickerWrapper.className = 'sticker-wrapper';
                        
                        const img = document.createElement('img');
                        img.src = sticker.url;
                        img.onclick = () => insertSticker(sticker.url);
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'sticker-delete-btn';
                        deleteBtn.innerHTML = '√ó';
                        deleteBtn.onclick = (e) => {
                            e.stopPropagation();
                            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Ë¥¥Á∫∏ÂêóÔºü')) {
                                deleteSticker(sticker.url);
                            }
                        };
                        
                        stickerWrapper.appendChild(img);
                        stickerWrapper.appendChild(deleteBtn);
                        container.appendChild(stickerWrapper);
                    });
                })
                .catch(error => console.error('Âä†ËΩΩË¥¥Á∫∏Â§±Ë¥•:', error));
        }

        // Ê∑ªÂä†Âà†Èô§Ë¥¥Á∫∏ÁöÑÂáΩÊï∞
        function deleteSticker(url) {
            fetch('/delete_sticker', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    loadStickers(); // ÈáçÊñ∞Âä†ËΩΩË¥¥Á∫∏ÂàóË°®
                } else {
                    alert(result.error || 'Âà†Èô§Â§±Ë¥•');
                }
            })
            .catch(error => {
                console.error('Âà†Èô§Ë¥¥Á∫∏Â§±Ë¥•:', error);
                alert('Âà†Èô§Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
            });
        }

        function insertSticker(url) {
            const socket = io();
            socket.emit('message', `[sticker]${url}[/sticker]`);
            document.getElementById('emoji-panel').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            const socket = io();
            const form = document.getElementById('message-form');
            const input = document.getElementById('input');
            const messages = document.getElementById('messages');
            const currentUsername = '{{ current_user.username }}';
            const fileInput = document.getElementById('file-input');
            const emojiBtn = document.querySelector('.emoji-btn');
            const emojiPanel = document.getElementById('emoji-panel');
            const emojis = document.querySelectorAll('.emoji');

            // Ë°®ÊÉÖÈù¢ÊùøÁõ∏ÂÖ≥‰∫ã‰ª∂
            emojiBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const isVisible = emojiPanel.style.display !== 'none';
                emojiPanel.style.display = isVisible ? 'none' : 'block';
                
                if (!isVisible) {
                    const btnRect = emojiBtn.getBoundingClientRect();
                    emojiPanel.style.left = `${btnRect.left}px`;
                    emojiPanel.style.bottom = `${window.innerHeight - btnRect.top + 10}px`;
                }
            });
            
            // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠Ë°®ÊÉÖÈù¢Êùø
            document.addEventListener('click', (e) => {
                if (!emojiPanel.contains(e.target) && !emojiBtn.contains(e.target)) {
                    emojiPanel.style.display = 'none';
                }
            });
            
            // ÁÇπÂáªË°®ÊÉÖÊèíÂÖ•Âà∞ËæìÂÖ•Ê°Ü
            emojis.forEach(emoji => {
                emoji.addEventListener('click', function() {
                    const input = document.getElementById('input');
                    const emojiText = this.getAttribute('data-emoji');
                    
                    const start = input.selectionStart;
                    const end = input.selectionEnd;
                    input.value = input.value.slice(0, start) + emojiText + input.value.slice(end);
                    
                    input.focus();
                    const newCursorPos = start + emojiText.length;
                    input.setSelectionRange(newCursorPos, newCursorPos);
                    
                    input.dispatchEvent(new Event('input'));
                    emojiPanel.style.display = 'none';
                });
            });

            // ÂàùÂßãÂåñË¥¥Á∫∏Èù¢Êùø
            const stickerTab = document.getElementById('stickers-tab');
            if (stickerTab) {
                loadStickers();
            }

            // Ê∑ªÂä†Âè≥ÈîÆËèúÂçïÁõ∏ÂÖ≥ÂèòÈáè
            const contextMenu = document.getElementById('contextMenu');
            const editMenuItem = document.getElementById('editMenuItem');
            const deleteMenuItem = document.getElementById('deleteMenuItem');
            let currentMessageId = null;

            function appendMessage(msgData) {
                console.log('Appending message:', msgData); // Ê∑ªÂä†Ë∞ÉËØïÊó•Âøó
                const messageDiv = document.createElement('div');
                const isOwn = msgData.username === currentUsername;
                messageDiv.className = `message ${isOwn ? 'message-own' : 'message-other'}`;
                messageDiv.setAttribute('data-message-id', msgData.id);

                // Ê∑ªÂä†Â§¥ÂÉè
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'message-avatar';
                const avatarImg = document.createElement('img');
                avatarImg.src = msgData.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${msgData.username}`;
                avatarImg.alt = msgData.username;
                avatarImg.onclick = () => showUserInfo(msgData.username);
                avatarDiv.appendChild(avatarImg);
                messageDiv.appendChild(avatarDiv);

                // Ê∂àÊÅØÂÜÖÂÆπÂÆπÂô®
                const contentContainer = document.createElement('div');
                contentContainer.className = 'message-container';

                // Áî®Êà∑Âêç
                const usernameDiv = document.createElement('div');
                usernameDiv.className = 'message-username';
                usernameDiv.textContent = msgData.username;
                contentContainer.appendChild(usernameDiv);

                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'message-content-wrapper';

                // Ê∂àÊÅØÂÜÖÂÆπ
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                
                // Ê£ÄÊü•ÊòØÂê¶ÊòØË¥¥Á∫∏Ê∂àÊÅØ
                if (msgData.text && msgData.text.startsWith('[sticker]') && msgData.text.endsWith('[/sticker]')) {
                    // ÊèêÂèñË¥¥Á∫∏URL
                    const stickerUrl = msgData.text.replace('[sticker]', '').replace('[/sticker]', '');
                    contentDiv.className = 'message-content sticker-message';
                    const img = document.createElement('img');
                    img.src = stickerUrl;
                    img.className = 'sticker-image';
                    contentDiv.appendChild(img);
                } else if (msgData.type === 'file') {
                    // ÂéüÊúâÁöÑÊñá‰ª∂Â§ÑÁêÜÈÄªËæë...
                } else {
                    // ÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ
                    contentDiv.textContent = msgData.text;
                }
                
                contentWrapper.appendChild(contentDiv);

                // Ê∑ªÂä†Ê∂àÊÅØ‰ø°ÊÅØÔºàÊó∂Èó¥Á≠âÔºâ
                const infoDiv = document.createElement('div');
                infoDiv.className = 'message-info';
                
                // Ê∑ªÂä†Êó∂Èó¥
                const timeSpan = document.createElement('span');
                timeSpan.className = 'message-time';
                timeSpan.textContent = msgData.timestamp || new Date().toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                infoDiv.appendChild(timeSpan);

                // Â¶ÇÊûúÊ∂àÊÅØË¢´ÁºñËæëËøáÔºåÊ∑ªÂä†ÁºñËæëÊ†áËÆ∞
                if (msgData.edited) {
                    const editedSpan = document.createElement('span');
                    editedSpan.className = 'message-edited';
                    editedSpan.textContent = '(Â∑≤ÁºñËæë)';
                    infoDiv.appendChild(editedSpan);
                }

                contentWrapper.appendChild(infoDiv);
                contentContainer.appendChild(contentWrapper);
                messageDiv.appendChild(contentContainer);

                // ‰∏∫Ê∂àÊÅØÊ∑ªÂä†Âè≥ÈîÆËèúÂçï‰∫ã‰ª∂Ôºà‰ªÖÈôêËá™Â∑±ÁöÑÊ∂àÊÅØÔºâ
                if (isOwn) {
                    messageDiv.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        currentMessageId = msgData.id;
                        showContextMenu(e.pageX, e.pageY);
                    });
                }

                messages.appendChild(messageDiv);
                messages.scrollTop = messages.scrollHeight;
            }

            function editMessage(messageId) {
                const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
                const contentDiv = messageDiv.querySelector('.message-content');
                
                // Â¶ÇÊûúÊòØË¥¥Á∫∏Ê∂àÊÅØÔºå‰∏çÂÖÅËÆ∏ÁºñËæë
                if (contentDiv.classList.contains('sticker-message')) {
                    return;
                }
                
                const originalText = contentDiv.textContent;
                
                contentDiv.innerHTML = `
                    <input type="text" class="edit-input" value="${originalText}">
                    <button class="save-edit">‰øùÂ≠ò</button>
                    <button class="cancel-edit">ÂèñÊ∂à</button>
                `;
                
                const editInput = contentDiv.querySelector('.edit-input');
                editInput.focus();
                
                contentDiv.querySelector('.save-edit').onclick = () => {
                    const newText = editInput.value.trim();
                    if (newText && newText !== originalText) {
                        socket.emit('edit_message', {
                            id: messageId,
                            text: newText
                        });
                    }
                    contentDiv.textContent = originalText;
                };
                
                contentDiv.querySelector('.cancel-edit').onclick = () => {
                    contentDiv.textContent = originalText;
                };
            }

            function deleteMessage(messageId) {
                if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Ê∂àÊÅØÂêóÔºü')) {
                    socket.emit('delete_message', { id: messageId });
                }
            }

            // Socket.io ‰∫ã‰ª∂ÁõëÂê¨
            socket.on('message', (msgData) => {
                console.log('Received message:', msgData); // Ê∑ªÂä†Ë∞ÉËØïÊó•Âøó
                appendMessage(msgData);
            });

            socket.on('message_status', (data) => {
                const messageDiv = document.querySelector(`[data-message-id="${data.id}"]`);
                if (messageDiv) {
                    const statusSpan = messageDiv.querySelector('.message-status');
                    if (statusSpan) statusSpan.textContent = data.status;
                }
            });

            socket.on('message_edited', (data) => {
                const messageDiv = document.querySelector(`[data-message-id="${data.id}"]`);
                if (messageDiv) {
                    const contentDiv = messageDiv.querySelector('.message-content');
                    contentDiv.textContent = data.text;
                    
                    const infoDiv = messageDiv.querySelector('.message-info');
                    if (!infoDiv.querySelector('.message-edited')) {
                        const editedSpan = document.createElement('span');
                        editedSpan.className = 'message-edited';
                        editedSpan.textContent = '(Â∑≤ÁºñËæë)';
                        infoDiv.insertBefore(editedSpan, infoDiv.firstChild);
                    }
                }
            });

            socket.on('message_deleted', (data) => {
                const messageDiv = document.querySelector(`[data-message-id="${data.id}"]`);
                if (messageDiv) {
                    messageDiv.remove();
                }
            });

            // Ë°®ÂçïÊèê‰∫§
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                clearTimeout(typingTimer);
                socket.emit('typing', { status: 'stopped' });
                
                if (input.value.trim()) {
                    socket.emit('message', input.value);
                    input.value = '';
                }
            });

            const typingStatus = document.getElementById('typing-status');
            let typingTimer;
            let typingUsers = new Set();

            // ‰øÆÊîπËæìÂÖ•ÁõëÂê¨ÈÉ®ÂàÜ
            input.addEventListener('input', () => {
                if (input.value.trim()) {  // Âè™ÊúâÂΩìËæìÂÖ•Ê°ÜÊúâÂÜÖÂÆπÊó∂ÊâçÂèëÈÄÅÁä∂ÊÄÅ
                    clearTimeout(typingTimer);
                    socket.emit('typing', { status: 'typing' });
                    
                    typingTimer = setTimeout(() => {
                        socket.emit('typing', { status: 'stopped' });
                    }, 2000);
                } else {
                    clearTimeout(typingTimer);
                    socket.emit('typing', { status: 'stopped' });
                }
            });

            // ‰øÆÊîπËæìÂÖ•Áä∂ÊÄÅÊõ¥Êñ∞ÂáΩÊï∞
            function updateTypingStatus() {
                if (typingUsers.size === 0) {
                    typingStatus.textContent = '';
                    typingStatus.style.display = 'none';
                    return;
                }

                const users = Array.from(typingUsers);
                let text = '';
                
                if (users.length === 1) {
                    text = `${users[0]} Ê≠£Âú®ËæìÂÖ•...`;
                } else if (users.length === 2) {
                    text = `${users[0]} Âíå ${users[1]} Ê≠£Âú®ËæìÂÖ•...`;
                } else {
                    text = `${users[0]} ÂíåÂÖ∂‰ªñ ${users.length - 1} ‰∫∫Ê≠£Âú®ËæìÂÖ•...`;
                }

                typingStatus.textContent = text;
                typingStatus.style.display = 'block';
                console.log('Typing status updated:', text); // Ê∑ªÂä†Ë∞ÉËØïÊó•Âøó
            }

            // ‰øÆÊîπËæìÂÖ•Áä∂ÊÄÅÁõëÂê¨
            socket.on('typing_status', (data) => {
                console.log('Received typing status:', data); // Ê∑ªÂä†Ë∞ÉËØïÊó•Âøó
                if (data.status === 'typing') {
                    typingUsers.add(data.username);
                } else {
                    typingUsers.delete(data.username);
                }
                updateTypingStatus();
            });

            // Â§ÑÁêÜÊñá‰ª∂ÈÄâÊã©
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    if (result.error) {
                        alert(result.error);
                    }
                    
                    // Ê∏ÖÈô§Êñá‰ª∂ËæìÂÖ•
                    fileInput.value = '';
                } catch (error) {
                    console.error('Upload failed:', error);
                    alert('Êñá‰ª∂‰∏ä‰º†Â§±Ë¥•');
                }
            });

            // ÊòæÁ§∫Áî®Êà∑‰ø°ÊÅØÂºπÁ™ó
            async function showUserInfo(username) {
                const userInfoModal = document.getElementById('userInfoModal');
                try {
                    const response = await fetch(`/user_info/${username}`);
                    const userData = await response.json();
                    
                    document.getElementById('userInfoAvatar').src = userData.avatar_url;
                    document.getElementById('userInfoUsername').textContent = userData.username;
                    document.getElementById('userInfoDisplayName').textContent = userData.display_name || userData.username;
                    document.getElementById('userInfoBio').textContent = userData.bio || 'Ëøô‰∏™Áî®Êà∑ÂæàÊáíÔºåËøòÊ≤°ÊúâÂ°´ÂÜôÁÆÄ‰ªã';
                    
                    userInfoModal.style.display = 'flex';
                } catch (error) {
                    console.error('Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•:', error);
                }
            }

            // ÊòæÁ§∫Âè≥ÈîÆËèúÂçï
            function showContextMenu(x, y) {
                contextMenu.style.display = 'block';
                contextMenu.style.left = `${x}px`;
                contextMenu.style.top = `${y}px`;
            }

            // ÈöêËóèÂè≥ÈîÆËèúÂçï
            function hideContextMenu() {
                contextMenu.style.display = 'none';
            }

            // Âè≥ÈîÆËèúÂçïÁÇπÂáª‰∫ã‰ª∂
            editMenuItem.addEventListener('click', () => {
                if (currentMessageId) {
                    editMessage(currentMessageId);
                    hideContextMenu();
                }
            });

            deleteMenuItem.addEventListener('click', () => {
                if (currentMessageId) {
                    deleteMessage(currentMessageId);
                    hideContextMenu();
                }
            });

            // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠Âè≥ÈîÆËèúÂçï
            document.addEventListener('click', hideContextMenu);

            // ÈòªÊ≠¢Âè≥ÈîÆËèúÂçïÂÜíÊ≥°
            contextMenu.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            // Ê∑ªÂä†Êñá‰ª∂Â§ßÂ∞èÊ†ºÂºèÂåñÂáΩÊï∞
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        });
    </script>
</body>
</html>